/**
 * 版本：v2.0.1
 * app.js 分装H5+常用的方法  微信端和APP端JS进行分类处理
 * plusInit 初始化H5+函数 其他js为通用JS
 *
 * **/
var $user={};var common={isFirst:true,waiting:null,play:null,init:function(){var me=this;window.addEventListener('touchmove',function(e){var target=e.target;if(target&&target.tagName==='TEXTAREA'&&target.scrollHeight>target.clientHeight){e.stopPropagation()}},true);if(window.plus){me.plusInit()}else{document.addEventListener('plusready',function(){me.plusInit()},false)}},plusInit:function(){var me=this;window.isPlus=true;if(plus.networkinfo.getCurrentType()==plus.networkinfo.CONNECTION_NONE){mui.toast("网络未连接")}plus.webview.currentWebview().setStyle({softinputMode:"adjustResize",scrollIndicator:'none'});me.setFullscreen=function(isTrue){!arguments.length?(isTrue=true):(isTrue=false);plus.navigator.setFullscreen(isTrue)};me.getStatusBarBackground=function(callback){var rgb=plus.navigator.getStatusBarBackground();callback(rgb)};me.setStatusBarBackground=function(color){plus.navigator.setStatusBarBackground(color)};me.storageSetItem=function(str,obj){plus.storage.setItem(str,JSON.stringify(obj))};me.storageGetItem=function(str,callback){if(me.IsJsonString(plus.storage.getItem(str))){var obj=JSON.parse(plus.storage.getItem(str));callback(obj)}else{var strs=plus.storage.getItem(str);callback(strs)}};me.galleryImg=function(callback){plus.gallery.pick(function(a){plus.io.resolveLocalFileSystemURL(a,function(entry){var s=entry.toLocalURL()+"?version="+new Date().getTime();callback(s)},function(e){mui.toast('读文件错误',{duration:2000,type:'div'});console.log("读文件错误："+e.message)})},function(e){mui.toast('取消选择',{duration:2000,type:'div'})},{filter:'image'})};me.cameraImg=function(callback){var cmr=plus.camera.getCamera();cmr.captureImage(function(e){plus.io.resolveLocalFileSystemURL(e,function(entry){var s=entry.toLocalURL()+"?version="+new Date().getTime();console.log(s);callback(s)},function(e){console.log("读取拍照文件错误："+e.message)})},function(error){mui.toast('取消拍照',{duration:2000,type:'div'});console.log('取消拍照')},{format:'jpg'})};me.actionSheet=function(title,cancel,btns,callback){if(arguments.length!=4){console.error('传入参数错误：1. title标题，2.底部按钮名称(取消)，3.按钮数组对象[{title:"1"},{title:"2"}],4.回调函数');return}if(!btns[0].title){console.error('按钮数组对象错误：样式 [{title:"1"},{title:"2"}]');return}if(!cancel){cancel="取消"}plus.nativeUI.actionSheet({title:title,cancel:cancel,buttons:btns},function(e){callback(e.index)})};me.resizeImage=function(src,callback){plus.zip.compressImage({src:src,dst:'_doc/a.jpg',overwrite:true,width:'270px',format:'jpg',quality:100},function(e){callback(e.target);},function(err){mui.toast('未知错误',{duration:2000,type:'div'})})};me.uploadImg=function(ajaxUrl,src,key){var task=plus.uploader.createUpload(ajaxUrl,{method:'post',blocksize:204800,timeout:10});task.addFile(src,{key:key});task.addData('type','uploadImg');task.addData('userId','');task.addEventListener('statechanged',function(upload,status){if(upload.state==4&&status==200){plus.uploader.clear();console.log(upload.responseText);}},false);task.start()};me.thirdparty=function(callback){window.loginid=function(id){var auth=auths[id];if(auth){var w=null;if(plus.os.name=="Android"){w=plus.nativeUI.showWaiting()}document.addEventListener("pause",function(){setTimeout(function(){w&&w.close();w=null},2000)},false);auth.login(function(){w&&w.close();w=null;userinfo(auth)},function(e){w&&w.close();w=null;plus.nativeUI.toast("获取用户信息失败："+e.message)})}else{plus.nativeUI.alert("无效的登录认证通道！",null,"登录")}};window.userinfo=function(a){a.getUserInfo(function(){callback(a.userInfo);},function(e){plus.nativeUI.alert("获取用户信息失败！",null,"登录")})};var authBtns=['weixin'];var auths={};var oauthArea=document.querySelector('.ys-thirdparty');plus.oauth.getServices(function(services){for(var i in services){var service=services[i];auths[service.id]=service;if(authBtns.indexOf(service.id)!=-1){var btn=document.createElement('div');btn.setAttribute('class','oauth-btn');btn.id=service.id;btn.setAttribute('onclick','loginid(this.id)');btn.style.backgroundImage='url("images/'+service.id+'.png")';btn.style.backgroundSize='2rem';btn.style.backgroundRepeat='no-repeat';btn.style.backgroundPosition='center';oauthArea.appendChild(btn)}}},function(e){oauthArea.style.display='none';plus.nativeUI.toast("获取登录认证失败："+e.message)})};me.logout=function(callback){var index=plus.storage.getItem("$authIndex");var serviceId=null,msg=null;plus.oauth.getServices(function(services){for(var i in services){var service=services[i];if(service.id==index){serviceId=service.id;msg=service.description}service.logout(function(){if(serviceId){callback();plus.nativeUI.toast("注销"+msg+"成功(微信注销不了)")}},function(e){})}},function(e){})}},getUrlParam:function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)");var r=window.location.search.substr(1).match(reg);if(r!=null){return unescape(r[2])}return null;},getTop:function(elem){var sum=elem.offsetTop;while(elem.offsetParent){sum+=elem.offsetParent.offsetTop;elem=elem.offsetParent}return sum},format:function(){Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]<10?"0"+o[k]:o[k]):(("00"+o[k]).substr((""+o[k]).length)))}}return fmt}},loadingIn:function(txt){if(!txt){txt=""}h('#ysLoading').remove();h('body').appendTo('<div class="ys-modal-loading" id="ysLoading"><div class="spinner-content"><div class="mui-spinner"></div>'+txt+'</div></div>')},loadingOut:function(){h('#ysLoading').remove()},checkType:function(str,type){switch(type){case 'email':return/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(str);case 'phone':return/^1[3|4|5|6|7|8][0-9]{9}$/.test(str);case 'tel':return/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/.test(str);case 'number':return/^[0-9]$/.test(str);case 'english':return/^[a-zA-Z]+$/.test(str);case 'chinese':return/^[\u4E00-\u9FA5]+$/.test(str);case 'lower':return/^[a-z]+$/.test(str);case 'upper':return/^[A-Z]+$/.test(str);case 'ID':return/^(^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$)|(^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])((\d{4})|\d{3}[Xx])$)$/.test(str);default:return true}},checkPwd:function(str){var nowLv=0;if(str.length<6){return nowLv}if(/[0-9]/.test(str)){nowLv+=1}if(/[a-z]/.test(str)){nowLv+=1}if(/[A-Z]/.test(str)){nowLv+=1}if(/[\.|-|_]/.test(str)){nowLv+=1}return nowLv},randomNumber:function(count){return Math.random().toString(count).substring(2)},countStr:function(str,strSplit){return str.split(strSplit).length-1},removeRepeatArray:function(arr){return Array.from(new Set(arr))},IsJsonString:function(str){try{JSON.parse(str)}catch(e){return false}return true},formatPassTime:function(startTime){var currentTime=Date.parse(new Date());var time=currentTime-startTime;var day=parseInt(time/(1000*60*60*24));var hour=parseInt(time/(1000*60*60));var min=parseInt(time/(1000*60));var month=parseInt(day/30);var year=parseInt(month/12);if(year){return year+"年前"}if(month){return month+"个月前"}if(day){return day+"天前"}if(hour){return hour+"小时前"}if(min){return min+"分钟前"}else{return '刚刚'}},countDown:function(btnID,times){if(btnID.getAttribute("disabled")=='disabled'){return}btnID.setAttribute("disabled","disabled");btnID.innerHTML=times+"s后重新发送";var outtime=setInterval(function(){times-=1;btnID.innerHTML=times+"s后重新发送";if(times<=0){clearInterval(outtime);btnID.innerHTML="发送验证码";btnID.removeAttribute("disabled")}},1000)},inputOnresize:function(elem){var me=this;var viewH1=document.documentElement.clientHeight;var viewH=0;mui(elem).on('focusin','input',function(){var scrolltop=me.getTop(this);onresize=function(){viewH=document.documentElement.clientHeight;if(viewH1!=viewH&&viewH<scrolltop+rem*4){mui(elem).scrollTo((viewH-rem*4-scrolltop),100);return}}})},hasClass:function(ele,cls){return(new RegExp('(\\s|^)'+cls+'(\\s|$)')).test(ele.className)},addClass:function(ele,cls){if(!hasClass(ele,cls)){ele.className+=' '+cls}},removeClass:function(ele,cls){if(this.hasClass(ele,cls)){var reg=new RegExp('(\\s|^)'+cls+'(\\s|$)');ele.className=ele.className.replace(reg,' ')}},ajax:function(url,data,times,callback,waiting){if(waiting){if(window.plus){waiting=plus.nativeUI.showWaiting()}else{waiting=null}}mui.ajax(url,{data:data,dataType:'json',type:'post',timeout:times||30000,success:function(data){waiting&&waiting.close();waiting=null;if(data.error_code==2){mui.toast('账号异地登录，请重新登录');localStorage.removeItem('user');clicked('login.html',true,'zoom-fade-out')}else{callback(data)}},error:function(a1,a2,a3){mui.toast(a1.status);waiting&&waiting.close();waiting=null}})},config:"http://multi-shop.wiwipu.com",getUser:function(){$user=JSON.parse(localStorage.getItem('user')||'{}');if(!$user.access_token){mui.toast('请登录');mui.plusReady(function(){setTimeout(function(){clicked('login.html',true,'zoom-fade-out')},200)})}}};common.init();(function(w){var immersed=0;var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);if(ms&&ms.length>=3){immersed=parseFloat(ms[2])}w.immersed=immersed;w.immersedStyle=function(opy){if(!immersed){return}var immersedTop=document.querySelector('.immersedTop');if(immersedTop){immersedTop.style.opacity=opy||0.3}else{var immersedDiv=document.createElement("div");immersedDiv.className='immersedTop';immersedDiv.style.height=immersed+'px';immersedDiv.style.opacity=opy||0.3;document.body.appendChild(immersedDiv)}};if(!immersed){return}immersedStyle(0.0001);var t=document.querySelectorAll('[data-header]');var tStyle=null;if(t.length>0){for(var i=0;i<t.length;i+=1){tStyle=parseFloat(getComputedStyle(t[i]).height);t[i].style.paddingTop=immersed+'px';t[i].style.height=tStyle+immersed+'px'}}t=document.querySelectorAll('[data-content]');if(t.length>0){for(var j=0;j<t.length;j+=1){tStyle=parseFloat(getComputedStyle(t[j]).paddingTop);t[j].style.paddingTop=tStyle+immersed+'px'}}})(window);function headError(type,elem){if(type=='user'){elem.src='images/user-default.png'}else{elem.src='images/shop-default.png'}}